<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runde Ecken Bild-Tool (Batch-Download)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        label { display: block; margin: 10px 0; }
        input[type="number"] { width: 60px; }
        button { margin-right: 10px; padding: 5px 10px; }
        input[disabled] { opacity: 0.6; }
    </style>
</head>
<body>
    <h1>Ecken abrunden</h1>

    <label>Bild(er) auswählen:
        <input type="file" id="inputImages" accept="image/*" multiple>
    </label>

    <label>Radius (px):
        <input type="number" id="radius" value="20" min="0">
    </label>

    <label>Margin (px):
        <input type="number" id="margin" value="0" min="0">
    </label>

    <label>Hintergrundfarbe:
        <input type="color" id="bgColor" value="#000000">
    </label>

    <label>
        <input type="checkbox" id="transparentBg" checked>
        Transparenter Hintergrund
    </label>

    <button id="downloadAllBtn">Alle herunterladen</button>

    <script>
        const inputImages = document.getElementById('inputImages');
        const radiusInput = document.getElementById('radius');
        const marginInput = document.getElementById('margin');
        const bgColorInput = document.getElementById('bgColor');
        const transparentBgCheckbox = document.getElementById('transparentBg');
        const downloadAllBtn = document.getElementById('downloadAllBtn');

        // Disable color picker if transparent
        bgColorInput.disabled = transparentBgCheckbox.checked;
        transparentBgCheckbox.addEventListener('change', () => {
            bgColorInput.disabled = transparentBgCheckbox.checked;
        });

        // Draw rounded corners on a canvas and return it
        function createRoundedCanvas(img) {
            const radius = parseInt(radiusInput.value, 10);
            const margin = parseInt(marginInput.value, 10);
            const bgColor = bgColorInput.value;
            const transparent = transparentBgCheckbox.checked;

            const w = img.width;
            const h = img.height;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = w + 2 * margin;
            canvas.height = h + 2 * margin;

            if (!transparent) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.save();
            ctx.beginPath();
            const x = margin, y = margin;
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + w - radius, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
            ctx.lineTo(x + w, y + h - radius);
            ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
            ctx.lineTo(x + radius, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.clip();

            ctx.drawImage(img, x, y);
            ctx.restore();
            return canvas;
        }

        // Read a file as DataURL (returns Promise)
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }

        // Delay helper
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Batch download function
        downloadAllBtn.addEventListener('click', async () => {
            const files = Array.from(inputImages.files);
            if (files.length === 0) {
                alert('Bitte zuerst mindestens ein Bild auswählen.');
                return;
            }
            for (let file of files) {
                try {
                    const dataURL = await readFileAsDataURL(file);
                    const img = new Image();
                    const imgLoad = new Promise(res => img.onload = res);
                    img.src = dataURL;
                    await imgLoad;
                    const canvas = createRoundedCanvas(img);

                    const dot = file.name.lastIndexOf('.');
                    const base = dot !== -1 ? file.name.substring(0, dot) : file.name;
                    const ext = dot !== -1 ? file.name.substring(dot) : '.png';
                    const downloadName = base + '-rounded' + ext;

                    const link = document.createElement('a');
                    link.download = downloadName;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Kurze Pause, damit Browser mehrere Downloads akzeptiert
                    await delay(300);
                } catch (err) {
                    console.error('Fehler beim Verarbeiten von', file.name, err);
                }
            }
        });
    </script>
</body>
</html>
